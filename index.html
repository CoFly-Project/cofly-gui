<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>
        IKH - CoFly
    </title>
    <!-- Favicon -->
    <link href="./assets/img/brand/favicon.png" rel="icon" type="image/png">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    <!-- Icons -->
    <!-- CSS Files -->
    <link href="css/argon-dashboard.css?v=1.1.0" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    
        <!--Add mapbox.js -->
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />

    <!--Add draw plugin -->
    <link rel='stylesheet' href='http://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' />
    <script src='http://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>
  
</head>

<body class="action_picker">

  <style>

.ld_projects {
    width: 15%;
    margin: 0 auto;
}

.buttons_holder {
    width: 100vw;
    margin: 0 auto;
    text-align: center;
    margin-top: 27%;
    position: absolute;
}

.ne_project {
    width: 20%;
    margin: 0 auto;
    display: inline-block;
    background: transparent;
    color: #333;
    padding: 10px;
    font-size: 20px;
    border: 1px solid #fec840;
    cursor: pointer;
}

.ld_projects {
    width: 20%;
    margin: 0 auto;
    display: inline-block;
    background: #fec840;
    color: #333;
    padding: 10px;
    font-size: 20px;
    margin-right: 10%;
    cursor: pointer;
}

  </style>


<input type="file" accept=".zip" >

  <div class="buttons_holder">
      
      <div class="ld_projects">Load Projects</div><div class="ne_project">New Project</div>
      
      <div class=""></div>
    </div>

    <script type="text/javascript">
      
      jQuery(document).ready(function(){

        jQuery('.ne_project').click(function(){

          window.location = "./map.html";

        });


        jQuery('.ld_projects').click(function(){

          window.location = "./all_projects.html";

        });

            // Check if projects exists else build it
    const fs = require("fs"); // Or `import fs from "fs";` with ESM
    if (fs.existsSync("projects")) {
        // Do something
        //alert('PROJECT ALREADY EXISTS');
    } else {
        //console.log("not exist");
        fs.mkdir('projects', function() {
            //fs.writeFile('',"");
        });

    }

    // Check if projects exists else build it
    if (fs.existsSync("projects_centers")) {
        // Do something
        //alert('PROJECT ALREADY EXISTS');
    } else {
        fs.mkdir('projects_centers', function() {
            fs.writeFileSync('./projects_centers/centers.txt',"plan_name:0;x:0;y:0");
        });
    }

      });
    </script>

    <script>
    jQuery(document).ready(function(){

        jQuery('input[type="file"]').change(function(){
            var get_file_path = document.getElementsByTagName('input')[0].files[0].path;
            var get_file_name = document.getElementsByTagName('input')[0].files[0].name;
            //console.log(get_file_name);
            // diabazw onoma gia na mporesw na ftiaxw path
            var read_name = get_file_name.split(".zip",3);
            //console.log(read_name);
            console.log(read_name[0]);

            const fs = require("fs"); // Or `import fs from "fs";` with ESM
            if (fs.existsSync('projects/'+read_name[0])) {
                // Do something
                //alert('PROJECT ALREADY EXISTS');
                extract_zip('/projects/'+read_name[0],get_file_path,read_name[0]);
            } else {
                //console.log("not exist");
                fs.mkdir('projects/'+read_name[0], function() {
                    extract_zip('/projects/'+read_name[0],get_file_path,read_name[0]);
                });

            }

            



            
            
        });
        
        // Extract Zip 
        function extract_zip(project_path,zip_path,project_name){

            console.log(project_path,zip_path);
                
            var path = require('path');
            var appDir = path.dirname(require.main.filename);
            var project_names = [];
            var extract = require('extract-zip');
            var source = zip_path;
            var target = appDir + project_path;
            console.log(target);


            extract(source, {dir: target}, function (err) {
            // extraction is complete. make sure to handle the err
            try{
                var data = JSON.parse(load_project_polygon(target+'/'));
                alert('Project Imoprted Succcesfully');
            }catch(error){
                console.log('Cant load');
                
                var rimraf = require("rimraf");
                rimraf(appDir+"/projects/"+project_name, function () { 
                    console.log("Remove Done"); 
                });
            }
            
            console.log(data["features"][0]["geometry"]);

            var polygonCenter = require('geojson-polygon-center');
            var center = polygonCenter(data["features"][0]["geometry"]);


            var load_centers = load_projects_centers();
            var split_projects_center = load_centers.split(",");
            
            jQuery.each(split_projects_center, function( index, value ) {
                temp_name = value.split("plan_name:");
                keep_name = temp_name[1].split(";");
                project_names.push(keep_name[0]);
            });

            var item_exists = jQuery.inArray( project_name, project_names );

            if(item_exists > 0){

                console.log('Do not touch center of project');

            }else{

                load_centers += ',plan_name:'+project_name+';x:'+center["coordinates"][0]+';y:'+center["coordinates"][1];

            const fs = require("fs");
            fs.mkdir('projects_centers', function() {
                fs.writeFileSync('./projects_centers/centers.txt', load_centers);
            });


            console.log('Centers Updated');

            }

        
            

            });

        }


        // Function in order to Call User database ( /login_system/users.txt)
        function load_project_polygon(file_path) {
            var fs = require('fs');
            //var rimraf = require("rimraf");
            //rimraf("/some/directory", function () { console.log("done"); });

           try {
                var contents = fs.readFileSync(file_path+'/map_data.geojson', 'utf8');
            }
            catch(error) {
                 console.error('Cant find Map_data.geojson');
            // expected output: ReferenceError: nonExistentFunction is not defined
            // Note - error messages will vary depending on browser
            }
            
            return contents;
        }

        // Function in order to Call User database ( /login_system/users.txt)
        function load_projects_centers() {
            var fs = require('fs');
            var contents = fs.readFileSync('./projects_centers/centers.txt', 'utf8');
            return contents;
        }


        


        
    });
    </script>

  </body>

</html>